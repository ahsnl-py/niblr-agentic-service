sources:

  source-bigquery:
    kind: bigquery
    project: niblr-agentic-service
    location: us
    # Optionally, you can specify credentials if not using default

  source-bigquery-job-listing:
    kind: bigquery
    project: niblr-agentic-service
    location: europe-west3

tools:
  
  search-job-listing-by-title:
    kind: bigquery-sql
    source: source-bigquery-job-listing
    description: Search for job listings by title from BigQuery.
    parameters:
      - name: title
        type: string
        description: The title of the job to search for.
    statement: |
      SELECT *
      FROM `niblr-agentic-service.raw_layer.job_listing`
      WHERE LOWER(title) LIKE CONCAT('%', @title, '%')
      LIMIT 100

  search-property-listing-by-location:
    kind: bigquery-sql
    source: source-bigquery
    description: Search for property listings in a specific location from BigQuery.
    parameters:
      - name: location
        type: string
        description: The location to search for.
    statement: |
      WITH property_listing AS (
        SELECT
          name as location, 
          REGEXP_EXTRACT(location, r', ([^,]+),') AS apartment_type,
          REGEXP_EXTRACT(location, r', ([0-9]+ ?m2)') AS size,
          SAFE_CAST(REGEXP_REPLACE(REGEXP_EXTRACT(price, r'([0-9 ]+)'), r' ', '') AS INT64) AS price_czk,
          link
        FROM
          `niblr-agentic-service.property_listing.property_listing_stg`
        WHERE
          TIMESTAMP_TRUNC(_PARTITIONTIME, MONTH) = TIMESTAMP("2025-07-01")
          AND REGEXP_EXTRACT(price, r'([0-9 ]+)') IS NOT NULL
      )
      SELECT * 
      FROM property_listing
      WHERE location LIKE CONCAT('%', @location, '%')
      LIMIT 100

  search-property-listing-by-price-range:
    kind: bigquery-sql
    source: source-bigquery
    description: Search for property listings within a price range from BigQuery.
    parameters:
      - name: min_price
        type: string
        description: Minimum price.
      - name: max_price
        type: string
        description: Maximum price.
    statement: |
      WITH property_listing AS (
        SELECT
          name as location, 
          REGEXP_EXTRACT(location, r', ([^,]+),') AS apartment_type,
          REGEXP_EXTRACT(location, r', ([0-9]+ ?m2)') AS size,
          SAFE_CAST(REGEXP_REPLACE(REGEXP_EXTRACT(price, r'([0-9 ]+)'), r' ', '') AS INT64) AS price_czk,
          link
        FROM
          `niblr-agentic-service.property_listing.property_listing_stg`
        WHERE
          TIMESTAMP_TRUNC(_PARTITIONTIME, MONTH) = TIMESTAMP("2025-07-01")
          AND REGEXP_EXTRACT(price, r'([0-9 ]+)') IS NOT NULL
      )
      SELECT * 
      FROM property_listing
      WHERE price_czk >= CAST(@min_price AS INT64) AND price_czk <= CAST(@max_price AS INT64)
      LIMIT 100

toolsets:

  job-listing-toolset-bigquery:
    - search-job-listing-by-title

  property-listing-toolset-bigquery:
    - search-property-listing-by-location
    - search-property-listing-by-price-range